(function(d){jQuery.fn.yiiUploadKit=function(a){var e=this,g=e.parent("div"),h=d("<ul>",{"class":"files"}).insertBefore(e),k=g.find(".empty-value"),c={init:function(){a.multiple&&(e.attr("multiple",!0),e.attr("name",e.attr("name")+"[]"));g.addClass("upload-kit");a.sortable&&h.sortable({placeholder:"upload-kit-item sortable-placeholder",tolerance:"pointer",forcePlaceholderSize:!0,update:function(){c.updateOrder()}});e.wrapAll(d('<li class="upload-kit-input"></div>')).after(d('<span class="glyphicon glyphicon-plus-sign add"></span>')).after(d('<span class="glyphicon glyphicon-circle-arrow-down drag"></span>')).after(d("<span/>",
    {"data-toggle":"popover","class":"glyphicon glyphicon-exclamation-sign error-popover"})).after('<div class="progress"><div class="progress-bar" role="progressbar" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100"></div></li>');h.on("click",".upload-kit-item .remove",c.removeItem);c.checkInputVisibility();c.fileuploadInit();c.dragInit();!a.acceptFileTypes||a.acceptFileTypes instanceof RegExp||(a.acceptFileTypes=new RegExp(eval(a.acceptFileTypes)))},fileuploadInit:function(){var b=e.fileupload({name:a.name||
"file",url:a.url,dropZone:e.parents(".upload-kit-input"),dataType:"json",singleFileUploads:!1,multiple:a.multiple,maxNumberOfFiles:a.maxNumberOfFiles,maxFileSize:a.maxFileSize,acceptFileTypes:a.acceptFileTypes,minFileSize:a.minFileSize,messages:a.messages,process:!0,getNumberOfFiles:c.getNumberOfFiles,start:function(f,b){g.find(".upload-kit-input").removeClass("error").addClass("in-progress");e.trigger("start");void 0!==a.start&&a.start(f,b)},processfail:function(f,a){a.files.error&&c.showError(a.files[0].error)},
    progressall:function(a,b){var c=parseInt(b.loaded/b.total*100,10);g.find(".progress-bar").attr("aria-valuenow",c).css("width",c+"%").text(c+"%")},done:function(f,b){d.each(b.result.files,function(a,b){b.error?c.showError(b.errors):c.createItem(b).appendTo(h)});c.handleEmptyValue();c.checkInputVisibility();e.trigger("done");void 0!==a.done&&a.done(f,b)},fail:function(b,d){c.showError(d.errorThrown);void 0!==a.fail&&a.fail(b,d)},always:function(b,c){g.find(".upload-kit-input").removeClass("in-progress");
        e.trigger("always");void 0!==a.always&&a.always(b,c)}});a.files&&(a.files.sort(function(b,a){return parseInt(b.order)-parseInt(a.order)}),b.fileupload("option","done").call(b,d.Event("done"),{result:{files:a.files}}),c.handleEmptyValue(),c.checkInputVisibility())},dragInit:function(){d(document).on("dragover",function(){d(".upload-kit-input").addClass("drag-highlight")});d(document).on("dragleave drop",function(){d(".upload-kit-input").removeClass("drag-highlight")})},showError:function(b){d.fn.popover&&
g.find(".error-popover").attr("data-content",b).popover({html:!0,trigger:"hover"});g.find(".upload-kit-input").addClass("error")},removeItem:function(b){b=d(this);var a=b.data("url"),e=c.request(a,"guid");a&&d.post(a,{guid:e},function(b){});b.parents(".upload-kit-item").remove();c.handleEmptyValue();c.checkInputVisibility()},request:function(b,a){for(var c=b.replace(/^\?/,"").split("&"),d=c.length,e=0,g;e<d;e++)if(c[e]&&(g=c[e].split("="),-1!=g[0].indexOf(a)))return g[1]},createItem:function(b){var f=
    a.name,e=c.getNumberOfFiles();a.multiple&&(f+="["+e+"]");f=d("<li>",{"class":"upload-kit-item done"}).append(d("<input/>",{name:f+"[order]",value:b.order,type:"hidden","data-role":"order"})).append(d("<input/>",{name:f+"[guid]",value:b.guid,type:"hidden"})).append(d("<span/>",{"class":"name",title:b.name,text:a.showPreviewFilename?b.name:null})).append(d("<span/>",{"class":"glyphicon glyphicon-remove-circle remove","data-url":b.deleteUrl}));b.type&&-1===b.type.search(/image\/.*/g)||!a.previewImage?
    (f.removeClass("image").addClass("not-image"),f.css("backgroundImage",""),f.find("span.name").text(b.name)):(f.removeClass("not-image").addClass("image"),f.prepend(d("<img/>",{src:b.url})),f.find("span.type").text(""));return f},checkInputVisibility:function(){var b=g.find(".upload-kit-input");a.maxNumberOfFiles&&c.getNumberOfFiles()>=a.maxNumberOfFiles?b.hide():b.show()},handleEmptyValue:function(){0<c.getNumberOfFiles()?k.val(c.getNumberOfFiles()):k.removeAttr("value")},getNumberOfFiles:function(){return g.find(".files .upload-kit-item").length},
    updateOrder:function(){h.find(".upload-kit-item").each(function(a,c){d(c).find("input[data-role=order]").val(a)})}};c.init.apply(this);return this}})(jQuery);